name: Deploy Next.js Dashboard to EC2
 
on:

  push:

    branches:

      - main
 
jobs:

  deploy:

    runs-on: ubuntu-latest
 
    steps:

      # 1️⃣ Checkout repository

      - name: Checkout repository

        uses: actions/checkout@v4
 
      # 2️⃣ Copy source code to EC2

      - name: Copy source to EC2

        uses: appleboy/scp-action@v0.1.4

        with:

          host: ${{ secrets.EC2_HOST }}

          username: ${{ secrets.EC2_USER }}

          key: ${{ secrets.EC2_SSH_KEY }}

          port: 22  # Hardcoded to 22 to fix "unknown port" error

          source: ".,!node_modules"

          target: "/home/${{ secrets.EC2_USER }}/cupid-ai-dashboard"

          # Standardize transfer settings

          rm: false

          strip_components: 0

          debug: true
 
      # 3️⃣ Install, build & restart app on EC2

      - name: Install, build & restart app on EC2

        uses: appleboy/ssh-action@v1.0.3

        with:

          host: ${{ secrets.EC2_HOST }}

          username: ${{ secrets.EC2_USER }}

          key: ${{ secrets.EC2_SSH_KEY }}

          port: 22 # Hardcoded to 22

          script: |

            # Use login shell to ensure node/npm/pm2 paths are loaded

            export NVM_DIR="$HOME/.nvm"

            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
 
            cd /home/${{ secrets.EC2_USER }}/cupid-ai-dashboard

            echo "Installing dependencies..."

            npm install  # Using install instead of ci for faster cache handling on small servers

            echo "Building project..."

            npm run build

            echo "Restarting app via PM2..."

            # Note: Using the name "cupid-frontend" to match your previous setup

            pm2 restart cupid-frontend || pm2 start npm --name "cupid-frontend" -- start

            pm2 save

            echo "✅ Deployment completed successfully"
 